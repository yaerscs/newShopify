<!-- Collection Grid Section -->
{{ 'collection-grid-page.css' | asset_url | stylesheet_tag }}

<div class="collection-grid-section section-{{ section.id }}">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h2 class="section-heading">{{ section.settings.heading }}</h2>
    {% endif %}
    
    <!-- Collection Navigation and Sort by Bar -->
    {% if section.settings.show_navigation or section.settings.show_sorting %}
      <div class="collection-nav-sort-bar">
        {% if section.settings.show_navigation %}
          <div class="collection-filters">
            <!-- Shop All Link -->
            <a href="#" data-collection="all" class="collection-filter-link active">{{ section.settings.collection_all_text | default: 'SHOP ALL' }}</a>
            
            <!-- Collection Links from Blocks -->
            {% for block in section.blocks %}
              {% if block.type == 'collection' and block.settings.collection != blank %}
                {% assign collection_item = collections[block.settings.collection] %}
                <a href="#" data-collection="{{ collection_item.handle }}" class="collection-filter-link">{{ collection_item.title }}</a>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        
        {% if section.settings.show_sorting %}
          <div class="sort-by-container">
            <div class="sort-by-label">{{ section.settings.sort_label }}</div>
            <div class="sort-by-dropdown">
              <select aria-label="Sort products">
                <option value="best-selling">Best Selling</option>
                <option value="price-ascending">Price: Low to High</option>
                <option value="price-descending">Price: High to Low</option>
                <option value="title-ascending">Alphabetically: A-Z</option>
                <option value="title-descending">Alphabetically: Z-A</option>
                <option value="created-descending">Date: Newest to Oldest</option>
                <option value="created-ascending">Date: Oldest to Newest</option>
              </select>
              <svg class="icon" viewBox="0 0 24 24">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}
    
    <div class="product-grid">
      <!-- Default Collection (Main Collection) -->
      {% assign main_collection = collections[section.settings.collection] %}
      
      <!-- Store all collections to be used in JavaScript -->
      <script>
        var collectionProducts = {
          'all': []
        };
      </script>
      
      <!-- Products from the main collection -->
      {% for product in main_collection.products %}
          <div class="product-card" 
               data-collection="all {{ main_collection.handle }}"
               data-type="{{ product.type | handle }}" 
               data-vendor="{{ product.vendor | handle }}" 
               data-tags="{{ product.tags | join: ',' | handle }}"
               data-price="{{ product.price }}"
               data-title="{{ product.title }}"
               data-created="{{ product.created_at | date: '%s' }}"
               data-index="{{ forloop.index }}">
            {% unless section.settings.show_view_product %}
              <a href="{{ product.url }}" class="product-link">
            {% endunless %}
              <div class="product-image-container">
                {% if product.compare_at_price > product.price and section.settings.show_sale_badge %}
                  <div class="sale-badge {% if section.settings.badge_gradient %}badge-gradient{% endif %}">
                    <span class="sale-badge-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"/><path d="M243.31,136,144,36.69A15.86,15.86,0,0,0,132.69,32H40a8,8,0,0,0-8,8v92.69A15.86,15.86,0,0,0,36.69,144L136,243.31a16,16,0,0,0,22.63,0l84.68-84.68a16,16,0,0,0,0-22.63ZM84,96A12,12,0,1,1,96,84,12,12,0,0,1,84,96Z"/></svg>
                    </span>
                    {% if section.settings.sale_badge_text != blank %}
                      {{ section.settings.sale_badge_text }}
                    {% else %}
                      {% assign savings = product.compare_at_price | minus: product.price %}
                      {% if section.settings.show_percentage_off %}
                        {% assign savings_percentage = savings | times: 100 | divided_by: product.compare_at_price %}
                        {{ savings_percentage }}% Off
                      {% else %}
                        Save {{ savings | money }}
                      {% endif %}
                    {% endif %}
                  </div>
                {% endif %}
                
                <div class="product-slider">
                  <div class="product-slider-wrapper">
                    {% if product.images.size > 0 %}
                      {% for image in product.images %}
                        <div class="product-slide">
                          <img src="{{ image | img_url: '500x' }}" alt="{{ product.title | escape }}" class="product-image">
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="product-slide">
                        <img src="{{ product.featured_image | img_url: '500x' }}" alt="{{ product.title | escape }}" class="product-image">
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <div class="collection-product-info">
                {% if product.images.size > 1 %}
                  <div class="product-dots">
                    {% for image in product.images %}
                      <span class="dot {% if forloop.first %}active{% endif %}"></span>
                    {% endfor %}
                  </div>
                {% endif %}
                
                {% if section.settings.show_rating %}
                  {% if section.settings.use_theme_colors %}
                    {% assign star_filled_color = settings.global_section_accent_1_color %}
                  {% else %}
                    {% assign star_filled_color = section.settings.star_color | default: '#FFD700' %}
                  {% endif %}
                  <div class="product-rating">
                    <!-- Get rating value with explicit fallback -->
                    {% assign metafield_rating = product.metafields.custom.rating.value %}
                    {% assign section_rating = section.settings.rating_value | default: 5 %}
                    
                    {% if metafield_rating and metafield_rating != blank and metafield_rating != "" %}
                      {% assign product_rating = metafield_rating | times: 1.0 %}
                    {% else %}
                      {% assign product_rating = section_rating | times: 1.0 %}
                    {% endif %}
                    
                    <!-- Ensure rating is at least 1 to see filled stars -->
                    {% if product_rating <= 0 %}
                      {% assign product_rating = 5 %}
                    {% endif %}
                    
                    <div class="stars">
                      {% for i in (1..5) %}
                        {% assign current_star = forloop.index %}
                        {% if current_star <= product_rating %}
                          <span class="star">
                            {% render 'e_icons', icon: 'star_icon', classes: 'star-filled', star_color: star_filled_color %}
                          </span>
                        {% else %}
                          <span class="star">
                            {% render 'e_icons', icon: 'star_icon', classes: 'star-empty', star_color: '#e0e0e0' %}
                          </span>
                        {% endif %}
                      {% endfor %}
                    </div>
                    {% if section.settings.show_rating_text %}
                      <span class="rating-number">({{ product.metafields.custom.rating.value | default: section.settings.rating_number | default: '4.7' }})</span>
                    {% endif %}
                  </div>
                {% endif %}
                
                <h3 class="product-title">{{ product.title }}</h3>
                
                <div class="collection-product-price">
                  {% if product.compare_at_price > product.price %}
                    <span class="collection-regular-price">{{ product.compare_at_price | money }}</span>
                  {% endif %}
                  <span class="collection-current-price">{{ product.price | money }}</span>
                </div>
                
                {% if section.settings.show_view_product %}
                  <div class="collection-view-product">
                    <a href="{{ product.url }}" class="collection-view-product-btn">
                      {{ section.settings.view_product_text | default: 'View Product' }}
                    </a>
                  </div>
                {% endif %}
                
                {% if section.settings.show_product_metadata %}
                  <div class="product-metadata">
                    {% if product.metafields.custom.rating != blank and section.settings.use_product_rating %}
                      <div class="metadata-item metadata-rating">
                        <span class="metadata-rating-value">{{ product.metafields.custom.rating.value }}</span>
                      </div>
                    {% endif %}
                    
                    {% if section.settings.metadata_field_1 != blank and product.metafields.custom[section.settings.metadata_field_1] != blank %}
                      <div class="metadata-item">
                        {% if section.settings.show_metadata_labels %}
                          <span class="metadata-label">{{ section.settings.metadata_label_1 | default: section.settings.metadata_field_1 }}:</span>
                        {% endif %}
                        <span class="metadata-value">{{ product.metafields.custom[section.settings.metadata_field_1] }}</span>
                      </div>
                    {% endif %}
                    
                    {% if section.settings.metadata_field_2 != blank and product.metafields.custom[section.settings.metadata_field_2] != blank %}
                      <div class="metadata-item">
                        {% if section.settings.show_metadata_labels %}
                          <span class="metadata-label">{{ section.settings.metadata_label_2 | default: section.settings.metadata_field_2 }}:</span>
                        {% endif %}
                        <span class="metadata-value">{{ product.metafields.custom[section.settings.metadata_field_2] }}</span>
                      </div>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% unless section.settings.show_view_product %}
              </a>
            {% endunless %}
          </div>
      {% endfor %}
      
      <!-- Products from the additional collections in blocks -->
      {% for block in section.blocks %}
        {% if block.type == 'collection' and block.settings.collection != blank %}
          {% assign block_collection = collections[block.settings.collection] %}
          {% unless block_collection.handle == main_collection.handle %}
            {% for product in block_collection.products %}
              <div class="product-card" 
                   data-collection="{{ block_collection.handle }}"
                   data-type="{{ product.type | handle }}" 
                   data-vendor="{{ product.vendor | handle }}" 
                   data-tags="{{ product.tags | join: ',' | handle }}"
                   data-price="{{ product.price }}"
                   data-title="{{ product.title }}"
                   data-created="{{ product.created_at | date: '%s' }}"
                   data-index="{{ forloop.index }}"
                   style="display: none;">
                {% unless section.settings.show_view_product %}
                  <a href="{{ product.url }}" class="product-link">
                {% endunless %}
                  <div class="product-image-container">
                    {% if product.compare_at_price > product.price and section.settings.show_sale_badge %}
                      <div class="sale-badge {% if section.settings.badge_gradient %}badge-gradient{% endif %}">
                        <span class="sale-badge-icon">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"/><path d="M243.31,136,144,36.69A15.86,15.86,0,0,0,132.69,32H40a8,8,0,0,0-8,8v92.69A15.86,15.86,0,0,0,36.69,144L136,243.31a16,16,0,0,0,22.63,0l84.68-84.68a16,16,0,0,0,0-22.63ZM84,96A12,12,0,1,1,96,84,12,12,0,0,1,84,96Z"/></svg>
                        </span>
                        {% if section.settings.sale_badge_text != blank %}
                          {{ section.settings.sale_badge_text }}
                        {% else %}
                          {% assign savings = product.compare_at_price | minus: product.price %}
                          {% if section.settings.show_percentage_off %}
                            {% assign savings_percentage = savings | times: 100 | divided_by: product.compare_at_price %}
                            {{ savings_percentage }}% Off
                          {% else %}
                            Save {{ savings | money }}
                          {% endif %}
                        {% endif %}
                      </div>
                    {% endif %}
                    
                    <div class="product-slider">
                      <div class="product-slider-wrapper">
                        {% if product.images.size > 0 %}
                          {% for image in product.images %}
                            <div class="product-slide">
                              <img src="{{ image | img_url: '500x' }}" alt="{{ product.title | escape }}" class="product-image">
                            </div>
                          {% endfor %}
                        {% else %}
                          <div class="product-slide">
                            <img src="{{ product.featured_image | img_url: '500x' }}" alt="{{ product.title | escape }}" class="product-image">
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  
                  <div class="collection-product-info">
                    {% if product.images.size > 1 %}
                      <div class="product-dots">
                        {% for image in product.images %}
                          <span class="dot {% if forloop.first %}active{% endif %}"></span>
                        {% endfor %}
                      </div>
                    {% endif %}
                    
                    {% if section.settings.show_rating %}
                      {% if section.settings.use_theme_colors %}
                        {% assign star_filled_color = settings.global_section_accent_1_color %}
                      {% else %}
                        {% assign star_filled_color = section.settings.star_color | default: '#FFD700' %}
                      {% endif %}
                      <div class="product-rating">
                        <!-- Get rating value with explicit fallback -->
                        {% assign metafield_rating = product.metafields.custom.rating.value %}
                        {% assign section_rating = section.settings.rating_value | default: 5 %}
                        
                        {% if metafield_rating and metafield_rating != blank and metafield_rating != "" %}
                          {% assign product_rating = metafield_rating | times: 1.0 %}
                        {% else %}
                          {% assign product_rating = section_rating | times: 1.0 %}
                        {% endif %}
                        
                        <!-- Ensure rating is at least 1 to see filled stars -->
                        {% if product_rating <= 0 %}
                          {% assign product_rating = 5 %}
                        {% endif %}
                        
                        <div class="stars">
                          {% for i in (1..5) %}
                            {% assign current_star = forloop.index %}
                            {% if current_star <= product_rating %}
                              <span class="star">
                                {% render 'e_icons', icon: 'star_icon', classes: 'star-filled', star_color: star_filled_color %}
                              </span>
                            {% else %}
                              <span class="star">
                                {% render 'e_icons', icon: 'star_icon', classes: 'star-empty', star_color: '#e0e0e0' %}
                              </span>
                            {% endif %}
                          {% endfor %}
                        </div>
                        {% if section.settings.show_rating_text %}
                          <span class="rating-number">({{ product.metafields.custom.rating.value | default: section.settings.rating_number | default: '4.7' }})</span>
                        {% endif %}
                      </div>
                    {% endif %}
                    
                    <h3 class="product-title">{{ product.title }}</h3>
                    
                    <div class="collection-product-price">
                      {% if product.compare_at_price > product.price %}
                        <span class="collection-regular-price">{{ product.compare_at_price | money }}</span>
                      {% endif %}
                      <span class="collection-current-price">{{ product.price | money }}</span>
                    </div>
                    
                    {% if section.settings.show_view_product %}
                      <div class="collection-view-product">
                        <a href="{{ product.url }}" class="collection-view-product-btn">
                          {{ section.settings.view_product_text | default: 'View Product' }}
                        </a>
                      </div>
                    {% endif %}
                    
                    {% if section.settings.show_product_metadata %}
                      <div class="product-metadata">
                        {% if product.metafields.custom.rating != blank and section.settings.use_product_rating %}
                          <div class="metadata-item metadata-rating">
                            <span class="metadata-rating-value">{{ product.metafields.custom.rating.value }}</span>
                          </div>
                        {% endif %}
                        
                        {% if section.settings.metadata_field_1 != blank and product.metafields.custom[section.settings.metadata_field_1] != blank %}
                          <div class="metadata-item">
                            {% if section.settings.show_metadata_labels %}
                              <span class="metadata-label">{{ section.settings.metadata_label_1 | default: section.settings.metadata_field_1 }}:</span>
                            {% endif %}
                            <span class="metadata-value">{{ product.metafields.custom[section.settings.metadata_field_1] }}</span>
                          </div>
                        {% endif %}
                        
                        {% if section.settings.metadata_field_2 != blank and product.metafields.custom[section.settings.metadata_field_2] != blank %}
                          <div class="metadata-item">
                            {% if section.settings.show_metadata_labels %}
                              <span class="metadata-label">{{ section.settings.metadata_label_2 | default: section.settings.metadata_field_2 }}:</span>
                            {% endif %}
                            <span class="metadata-value">{{ product.metafields.custom[section.settings.metadata_field_2] }}</span>
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% unless section.settings.show_view_product %}
                  </a>
                {% endunless %}
              </div>
            {% endfor %}
          {% endunless %}
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<style>
  /* Dynamic styles for section */
  .section-{{ section.id }} {
    padding: {{ section.settings.padding_top | default: 40 }}px 0 {{ section.settings.padding_bottom | default: 40 }}px;
    background-color: {% if section.settings.use_theme_colors %}{{ settings.global_section_background_color }}{% else %}{{ section.settings.background_color }}{% endif %};
  }
  
  /* Override global star styles with section-specific styling */
  .section-{{ section.id }} .star {
    width: 16px;
    height: 16px;
    margin: 0;
    display: inline-block;
    align-content: center;
    margin-right: -3px !important;
    line-height: 1;
    position: relative;
  }
  
  .section-{{ section.id }} .star svg {
    width: 100%;
    height: 100%;
    display: block;
  }
  
  .section-{{ section.id }} .star-filled,
  .section-{{ section.id }} .star-filled svg {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.star_color | default: '#FFD700' }}{% endif %} !important;
    fill: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.star_color | default: '#FFD700' }}{% endif %} !important;
  }
  
  .section-{{ section.id }} .star-empty,
  .section-{{ section.id }} .star-empty svg {
    color: #e0e0e0 !important;
    fill: #e0e0e0 !important;
    opacity: 0.5;
  }
  
  .section-{{ section.id }} .section-heading {
    text-align: {{ section.settings.heading_alignment | default: 'center' }};
    margin-bottom: 30px;
    font-size: {{ section.settings.heading_size | default: 28 }}px;
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.heading_color | default: '#000000' }}{% endif %} !important;
  }
  
  .collection-grid-section.section-{{ section.id }} h2.section-heading {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.heading_color | default: '#000000' }}{% endif %} !important;
  }
  
  /* Product card dynamic styles */
  .section-{{ section.id }} .product-card {
    background: {% if section.settings.use_theme_colors %}{{ settings.global_section_background_color }}{% else %}{{ section.settings.card_background | default: '#ffffff' }}{% endif %};
    border-radius: {{ section.settings.card_radius | default: 8 }}px;
    border: 1px solid {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color | color_modify: 'alpha', 0.1 | default: 'rgb(240, 240, 240)' }}{% else %}rgb(240, 240, 240){% endif %};
  }
  
  /* Product image container */
  .section-{{ section.id }} .product-image-container {
    background: {{ section.settings.image_background | default: '#f8f8f8' }};
  }
  
  .section-{{ section.id }} .product-image {
    object-fit: {{ section.settings.image_fit | default: 'contain' }};
  }
  
  /* Sale badge */
  .section-{{ section.id }} .sale-badge {
    background: {{ section.settings.badge_background | default: '#000000' }};
    color: {{ section.settings.badge_color | default: '#ffffff' }};
    border-radius: {{ section.settings.badge_radius | default: 4 }}px;
  }
  
  .section-{{ section.id }} .badge-gradient {
    background: linear-gradient(135deg, {{ section.settings.badge_background | default: '#000000' }}, {{ section.settings.badge_gradient_color | default: '#666666' }});
  }
  
  .section-{{ section.id }} .sale-badge-icon svg {
    fill: {{ section.settings.badge_color | default: '#ffffff' }};
  }
  
  /* Product navigation dots */
  .section-{{ section.id }} .dot {
    width: {{ section.settings.dot_size | default: 6 }}px;
    height: {{ section.settings.dot_size | default: 6 }}px;
    background: {{ section.settings.dot_color | default: '#cccccc' }};
  }
  
  .section-{{ section.id }} .dot.active {
    background: {{ section.settings.dot_active_color | default: '#000000' }};
  }
  
  /* Product info section dynamic styles */
  .section-{{ section.id }} .product-title {
    font-size: 20px;
    font-weight: var(--font-weight-bold) !important;
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.title_color | default: '#000000' }}{% endif %} !important;
  }
  
  .section-{{ section.id }} .collection-product-price {
    font-size: {{ section.settings.price_size | plus: 0 | default: 15 }}px;
  }
  
  .section-{{ section.id }} .collection-regular-price {
    color: {% if section.settings.use_theme_colors %}#b3b3b3{% else %}{{ section.settings.compare_price_color | default: '#999999' }}{% endif %};
  }
  
  .section-{{ section.id }} .collection-current-price {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.price_color | default: '#000000' }}{% endif %};
  }
  
  /* Product rating dynamic styles */
  .section-{{ section.id }} .product-rating {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  
  .section-{{ section.id }} .stars {
    display: flex;
    align-items: center;
    margin-right: 8px;
  }
  
  .section-{{ section.id }} .rating-number {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.rating_text_color | default: '#000000' }}{% endif %};
    font-size: 14px;
    font-weight: {{ section.settings.rating_text_weight | default: '600' }};
  }
  
  /* Product metadata dynamic styles */
  .section-{{ section.id }} .product-metadata {
    font-size: {{ section.settings.metadata_font_size }}px;
  }
  
  .section-{{ section.id }} .metadata-label {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color | color_darken: 10 }}{% else %}{{ section.settings.metadata_label_color }}{% endif %};
    font-weight: {{ section.settings.metadata_label_weight }};
  }
  
  .section-{{ section.id }} .metadata-value {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.metadata_value_color }}{% endif %};
  }
  
  .section-{{ section.id }} .metadata-rating-value {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.metadata_rating_color }}{% endif %};
  }
  
  .section-{{ section.id }} .metadata-stars {
    display: flex;
    align-items: center;
  }
  
  .section-{{ section.id }} .metadata-stars .star {
    width: 12px;
    height: 12px;
    margin-right: -2px;
  }
  
  .section-{{ section.id }} .metadata-stars .star-filled,
  .section-{{ section.id }} .metadata-stars .star-filled svg {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.star_color | default: '#FFD700' }}{% endif %} !important;
    fill: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.star_color | default: '#FFD700' }}{% endif %} !important;
  }
  
  .section-{{ section.id }} .metadata-stars .star-empty,
  .section-{{ section.id }} .metadata-stars .star-empty svg {
    color: #e0e0e0 !important;
    fill: #e0e0e0 !important;
    opacity: 0.5;
  }
  
  /* Collection Navigation and Sort Bar dynamic styles */
  .section-{{ section.id }} .collection-nav-sort-bar {
    border-bottom: 1px solid {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color | color_modify: 'alpha', 0.1 }}{% else %}{{ section.settings.nav_border_color | default: "rgba(0, 0, 0, 0.1)" }}{% endif %};
  }

  .section-{{ section.id }} .collection-filter-link {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.nav_text_color | default: "#000000" }}{% endif %};
  }

  .section-{{ section.id }} .collection-filter-link:hover,
  .section-{{ section.id }} .collection-filter-link.active {
    border-bottom-color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.nav_active_color | default: "#000000" }}{% endif %};
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.nav_active_color | default: "#000000" }}{% endif %};
  }

  .section-{{ section.id }} .sort-by-label {
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.sort_label_color | default: "#000000" }}{% endif %};
  }

  .section-{{ section.id }} .sort-by-dropdown select {
    background-color: {% if section.settings.use_theme_colors %}{{ settings.global_section_background_color }}{% else %}{{ section.settings.sort_dropdown_bg | default: "transparent" }}{% endif %};
    border: 1px solid {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color | color_modify: 'alpha', 0.2 }}{% else %}{{ section.settings.sort_dropdown_border | default: "#e4e4e4" }}{% endif %};
    border-radius: {% if section.settings.use_theme_colors %}{{ settings.global_section_border_radius | default: 0 }}px{% else %}{{ section.settings.sort_dropdown_radius | default: 4 }}px{% endif %};
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.sort_dropdown_text | default: "#000000" }}{% endif %};
  }

  .section-{{ section.id }} .sort-by-dropdown .icon {
    stroke: {% if section.settings.use_theme_colors %}{{ settings.global_section_text_color }}{% else %}{{ section.settings.sort_dropdown_text | default: "currentColor" }}{% endif %};
  }

  /* View Product Button dynamic styles */
  .section-{{ section.id }} .collection-view-product-btn {
    background-color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color }}{% else %}{{ section.settings.view_product_background | default: '#000000' }}{% endif %};
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_background_color }}{% else %}{{ section.settings.view_product_color | default: '#ffffff' }}{% endif %};
    border-radius: {{ section.settings.view_product_radius | default: 6 }}px;
  }

  .section-{{ section.id }} .collection-view-product-btn:hover {
    background-color: {% if section.settings.use_theme_colors %}{{ settings.global_section_accent_1_color | color_darken: 10 }}{% else %}{{ section.settings.view_product_background | default: '#000000' | color_darken: 10 }}{% endif %};
    color: {% if section.settings.use_theme_colors %}{{ settings.global_section_background_color }}{% else %}{{ section.settings.view_product_color | default: '#ffffff' }}{% endif %};
  }

  /* Responsive dynamic styles */
  @media (max-width: 767px) {
    .section-{{ section.id }} .product-metadata {
      font-size: {{ section.settings.metadata_font_size | minus: 1 }}px;
    }
    
    .section-{{ section.id }} .stars {
      font-size: 12px;
    }
    
    .section-{{ section.id }} .rating-number {
      font-size: 12px;
    }
    
    .section-{{ section.id }} .star {
      width: 16px;
      height: 16px;
      margin-right: -3px !important;
    }
    
    .section-{{ section.id }} .product-title {
      font-size: 19px;
    }
    
    .section-{{ section.id }} .collection-product-price {
      font-size: {{ section.settings.price_size | plus: 0 | default: 16 }}px;
    }
    
    .section-{{ section.id }} .metadata-stars {
      font-size: 11px;
    }
    
    .section-{{ section.id }} .dot {
      width: 6px;
      height: 6px;
    }
  }
  
  @media (max-width: 484px) {
    .section-{{ section.id }} .product-metadata {
      font-size: {{ section.settings.metadata_font_size | minus: 2 }}px;
    }
    
    .section-{{ section.id }} .metadata-stars {
      font-size: 10px;
    }
    
    .section-{{ section.id }} .stars {
      font-size: 10px;
    }
    
    .section-{{ section.id }} .rating-number {
      font-size: 10px;
    }
    
    .section-{{ section.id }} .star {
      width: 14px;
      height: 14px;
      margin-right: -2px;
    }
    
    .section-{{ section.id }} .product-title {
      font-size: 17px !important;
    }
    
    .section-{{ section.id }} .collection-product-price {
      font-size: {{ section.settings.price_size | plus: 0 | default: 15 }}px;
    }
  }
</style>

<script>
  // Image slider functionality
  document.addEventListener('DOMContentLoaded', function() {
    const sliders = document.querySelectorAll('.section-{{ section.id }} .product-slider');
    
    sliders.forEach(slider => {
      const wrapper = slider.querySelector('.product-slider-wrapper');
      const slides = slider.querySelectorAll('.product-slide');
      const card = slider.closest('.product-card');
      const dots = card.querySelectorAll('.dot');
      
      if (slides.length <= 1) return; // Skip if there's only one slide
      
      let currentSlide = 0;
      const slideCount = slides.length;
      
      // Initialize dots
      updateDots();
      
      // Touch swipe functionality
      let touchStartX = 0;
      let touchEndX = 0;
      
      slider.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      }, {passive: true});
      
      slider.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, {passive: true});
      
      // Mouse drag functionality for desktop
      let isDragging = false;
      let startPosX = 0;
      let currentTranslate = 0;
      
      slider.addEventListener('mousedown', e => {
        e.preventDefault();
        isDragging = true;
        startPosX = e.clientX;
        slider.style.cursor = 'grabbing';
      });
      
      slider.addEventListener('mousemove', e => {
        if (!isDragging) return;
        e.preventDefault();
        const moveX = e.clientX - startPosX;
        const slideWidth = slider.offsetWidth;
        
        // Limit movement to prevent excessive drag
        if (Math.abs(moveX) < slideWidth * 0.5) {
          wrapper.style.transform = `translateX(${-currentSlide * 100 + (moveX / slideWidth * 100)}%)`;
        }
      });
      
      document.addEventListener('mouseup', e => {
        if (!isDragging) return;
        
        isDragging = false;
        slider.style.cursor = 'grab';
        
        const moveX = e.clientX - startPosX;
        const threshold = slider.offsetWidth * 0.2; // 20% of slide width
        
        if (moveX < -threshold) {
          // Dragged left - go to next slide
          currentSlide = Math.min(currentSlide + 1, slideCount - 1);
        } else if (moveX > threshold) {
          // Dragged right - go to previous slide
          currentSlide = Math.max(currentSlide - 1, 0);
        }
        
        updateSlider();
      });
      
      document.addEventListener('mouseleave', () => {
        if (isDragging) {
          isDragging = false;
          slider.style.cursor = 'grab';
          updateSlider();
        }
      });
      
      function handleSwipe() {
        const threshold = 50; // Minimum swipe distance
        
        if (touchStartX - touchEndX > threshold) {
          // Swipe left - go to next slide
          currentSlide = Math.min(currentSlide + 1, slideCount - 1);
          updateSlider();
        } else if (touchEndX - touchStartX > threshold) {
          // Swipe right - go to previous slide
          currentSlide = Math.max(currentSlide - 1, 0);
          updateSlider();
        }
      }
      
      // Update slider position
      function updateSlider() {
        wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        updateDots();
      }
      
      // Update dots
      function updateDots() {
        if (dots && dots.length) {
          dots.forEach((dot, i) => {
            if (i === currentSlide) {
              dot.classList.add('active');
            } else {
              dot.classList.remove('active');
            }
          });
        }
      }
      
      // Connect dots to slides (if they exist)
      if (dots && dots.length) {
        dots.forEach((dot, i) => {
          dot.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            currentSlide = i;
            updateSlider();
          });
        });
      }
    });
    
    // Collection selection functionality
    const collectionLinks = document.querySelectorAll('.section-{{ section.id }} .collection-filter-link');
    const productCards = document.querySelectorAll('.section-{{ section.id }} .product-card');
    
    collectionLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove active class from all links
        collectionLinks.forEach(l => l.classList.remove('active'));
        
        // Add active class to clicked link
        this.classList.add('active');
        
        const collectionHandle = this.getAttribute('data-collection');
        
        // Show/hide product cards based on collection
        productCards.forEach(card => {
          const cardCollections = card.getAttribute('data-collection') || '';
          
          if (collectionHandle === 'all' || cardCollections.includes(collectionHandle)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      });
    });
    
    // Sort functionality
    const sortSelect = document.querySelector('.section-{{ section.id }} .sort-by-dropdown select');
    
    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        const selectedSort = this.value;
        const productGrid = document.querySelector('.section-{{ section.id }} .product-grid');
        
        // Get only the visible products
        const visibleProducts = Array.from(productCards).filter(card => card.style.display !== 'none');
        
        // Sort products based on selection
        visibleProducts.sort((a, b) => {
          switch(selectedSort) {
            case 'price-ascending':
              return parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price'));
            case 'price-descending':
              return parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price'));
            case 'title-ascending':
              return a.getAttribute('data-title').localeCompare(b.getAttribute('data-title'));
            case 'title-descending':
              return b.getAttribute('data-title').localeCompare(a.getAttribute('data-title'));
            case 'created-ascending':
              return new Date(a.getAttribute('data-created')) - new Date(b.getAttribute('data-created'));
            case 'created-descending':
              return new Date(b.getAttribute('data-created')) - new Date(a.getAttribute('data-created'));
            default: // best-selling or default
              return parseInt(a.getAttribute('data-index')) - parseInt(b.getAttribute('data-index'));
          }
        });
        
        // Re-append sorted products to the grid
        visibleProducts.forEach(product => {
          productGrid.appendChild(product);
        });
      });
    }
  });
</script>

{% schema %}
{
  "name": "Collection Grid Page",
  "settings": [
    {
      "type": "header",
      "content": "Collection Settings"
    },
    {
      "type": "checkbox",
      "id": "use_theme_colors",
      "default": true,
      "label": "Use Theme Colors",
      "info": "Apply the global theme colors to this section - text, pricing and stars"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Section Background Color",
      "default": "#FFFFFF",
      "info": "Background color for the entire section when theme colors are disabled"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Main Collection",
      "info": "This is the default collection that will be shown for 'Shop All'"
    },
    {
      "type": "header",
      "content": "Section Layout"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Collection"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 40,
      "step": 1,
      "default": 28,
      "label": "Heading font size"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40,
      "label": "Top padding"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40,
      "label": "Bottom padding"
    },
    {
      "type": "header",
      "content": "Product Card"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "image_background",
      "label": "Image background",
      "default": "#f8f8f8"
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "Image fit",
      "options": [
        {
          "value": "contain",
          "label": "Contain"
        },
        {
          "value": "cover",
          "label": "Cover"
        }
      ],
      "default": "contain"
    },
    {
      "type": "range",
      "id": "card_radius",
      "min": 0,
      "max": 30,
      "step": 1,
      "default": 8,
      "label": "Card corner radius"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "price_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16,
      "label": "Price font size"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "compare_price_color",
      "label": "Compare price color",
      "default": "#999999"
    },
    {
      "type": "header",
      "content": "Sale Badge"
    },
    {
      "type": "checkbox",
      "id": "show_sale_badge",
      "default": true,
      "label": "Show sale badge"
    },
    {
      "type": "text",
      "id": "sale_badge_text",
      "label": "Custom sale badge text",
      "info": "Leave blank to show savings amount"
    },
    {
      "type": "checkbox",
      "id": "show_percentage_off",
      "default": false,
      "label": "Show percentage instead of amount"
    },
    {
      "type": "color",
      "id": "badge_background",
      "label": "Badge background",
      "default": "#FFEAE6"
    },
    {
      "type": "checkbox",
      "id": "badge_gradient",
      "default": false,
      "label": "Enable badge gradient"
    },
    {
      "type": "color",
      "id": "badge_gradient_color",
      "label": "Badge gradient color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "badge_color",
      "label": "Badge text color",
      "default": "#FF3C16"
    },
    {
      "type": "range",
      "id": "badge_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 4,
      "label": "Badge corner radius"
    },
    {
      "type": "header",
      "content": "Product Image Dots"
    },
    {
      "type": "range",
      "id": "dot_size",
      "min": 6,
      "max": 16,
      "step": 1,
      "default": 10,
      "label": "Dot size"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot color",
      "default": "#cccccc"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Active dot color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Product Rating"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": true,
      "label": "Show product rating"
    },
    {
      "type": "range",
      "id": "rating_value",
      "min": 0,
      "max": 5,
      "step": 0.5,
      "default": 5,
      "label": "Rating value"
    },
    {
      "type": "checkbox",
      "id": "show_rating_text",
      "default": true,
      "label": "Show rating number"
    },
    {
      "type": "text",
      "id": "rating_number",
      "label": "Rating number",
      "default": "4.7",
      "info": "Enter the rating number"
    },
    {
      "type": "color",
      "id": "star_color",
      "label": "Star color",
      "default": "#FFC107"
    },
    {
      "type": "color",
      "id": "rating_text_color",
      "label": "Rating text color",
      "default": "#777777"
    },
    {
      "type": "select",
      "id": "rating_text_weight",
      "label": "Rating text weight",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "bold",
          "label": "Bold"
        }
      ],
      "default": "normal"
    },
    {
      "type": "header",
      "content": "Product Metadata"
    },
    {
      "type": "checkbox",
      "id": "show_product_metadata",
      "default": false,
      "label": "Show product metadata",
      "info": "Display metadata from product.metafields.custom"
    },
    {
      "type": "checkbox",
      "id": "use_product_rating",
      "default": true,
      "label": "Use per-product rating",
      "info": "Uses product.metafields.custom.rating value for each product"
    },
    {
      "type": "text",
      "id": "metadata_field_1",
      "label": "Metadata field 1",
      "info": "Enter the key name of your first custom metafield (e.g. 'size', 'material')"
    },
    {
      "type": "text",
      "id": "metadata_label_1",
      "label": "Label for field 1",
      "info": "Custom label to display before the metafield value"
    },
    {
      "type": "text",
      "id": "metadata_field_2",
      "label": "Metadata field 2",
      "info": "Enter the key name of your second custom metafield"
    },
    {
      "type": "text",
      "id": "metadata_label_2",
      "label": "Label for field 2",
      "info": "Custom label to display before the metafield value"
    },
    {
      "type": "checkbox",
      "id": "show_metadata_labels",
      "default": true,
      "label": "Show metadata labels"
    },
    {
      "type": "paragraph",
      "content": "### How to add product metadata and ratings\n\n1. Go to your Shopify admin > Products > Select a product > Metafields\n2. Add a new metafield in the 'Custom' namespace\n3. For product ratings: create a metafield with key 'rating' and number type (decimal) with value between 0-5\n4. For other metadata: create metafields with your desired keys and use those key names in the fields above\n5. Repeat for each product you want to display metadata for"
    },
    {
      "type": "header",
      "content": "Metadata Styling"
    },
    {
      "type": "range",
      "id": "metadata_font_size",
      "min": 10,
      "max": 18,
      "step": 1,
      "default": 12,
      "label": "Metadata font size"
    },
    {
      "type": "color",
      "id": "metadata_label_color",
      "label": "Metadata label color",
      "default": "#666666"
    },
    {
      "type": "select",
      "id": "metadata_label_weight",
      "label": "Metadata label weight",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "bold",
          "label": "Bold"
        }
      ],
      "default": "bold"
    },
    {
      "type": "color",
      "id": "metadata_value_color",
      "label": "Metadata value color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "metadata_rating_color",
      "label": "Metadata rating color",
      "default": "#333333"
    },
    {
      "type": "header",
      "content": "Navigation & Sorting"
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "default": true,
      "label": "Show collection navigation"
    },
    {
      "type": "text",
      "id": "collection_all_text",
      "label": "Shop All text",
      "default": "Shop All"
    },
    {
      "type": "checkbox",
      "id": "show_sorting",
      "default": true,
      "label": "Show sort-by dropdown"
    },
    {
      "type": "text",
      "id": "sort_label",
      "label": "Sort by label",
      "default": "SORT BY:"
    },
    {
      "type": "header",
      "content": "Navigation & Sorting Colors"
    },
    {
      "type": "color",
      "id": "nav_text_color",
      "label": "Navigation Text Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "nav_active_color",
      "label": "Navigation Active Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "nav_border_color",
      "label": "Navigation Border Color",
      "default": "rgba(0, 0, 0, 0.1)"
    },
    {
      "type": "color",
      "id": "sort_label_color",
      "label": "Sort Label Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "sort_dropdown_bg",
      "label": "Sort Dropdown Background",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "sort_dropdown_text",
      "label": "Sort Dropdown Text",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "sort_dropdown_border",
      "label": "Sort Dropdown Border",
      "default": "#e4e4e4"
    },
    {
      "type": "range",
      "id": "sort_dropdown_radius",
      "min": 0,
      "max": 30,
      "step": 1,
      "label": "Sort Dropdown Border Radius",
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "show_view_product",
      "default": true,
      "label": "Show View Product button"
    },
    {
      "type": "text",
      "id": "view_product_text",
      "label": "View Product button text",
      "default": "View Product"
    },
    {
      "type": "range",
      "id": "view_product_radius",
      "min": 0,
      "max": 30,
      "step": 1,
      "default": 6,
      "label": "View product button radius"
    },
    {
      "type": "color",
      "id": "view_product_background",
      "label": "View product button background",
      "default": "#000000",
      "info": "Used when 'Use Theme Colors' is disabled"
    },
    {
      "type": "color",
      "id": "view_product_color",
      "label": "View product button text color",
      "default": "#ffffff",
      "info": "Used when 'Use Theme Colors' is disabled"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Collection Grid Page",
      "category": "Collection"
    }
  ]
}
{% endschema %} 