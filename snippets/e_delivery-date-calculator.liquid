{% comment %}
  Delivery Date Calculator
  Calculates and displays an estimated delivery date
  
  Parameters:
  - shipping_days: Number of days for shipping (default: 5)
  - holidays: Array of holiday dates in YYYY-MM-DD format (default: empty array)
  - text_before: Text to display before the date (default: 'Arrives by')
  - text_after: Text to display after the date (default: '')
  - show_icon: Whether to show the calendar icon (default: true)
  - accent_color: Color for the accent elements (default: '#00C7FF')
  - text_color: Color for the text (default: '#333333') -> Now will use dd_text_color if provided
  - background_color: Color for the background (default: 'transparent')
  - output_format: 'normal' for styled html or 'text_only' for plain text (default: 'normal')
  - dd_text_color: Custom text color from sticky ATC
  - dd_font_weight: Custom font weight from sticky ATC
  - dd_desktop_font_size: Custom desktop font size from sticky ATC
  - dd_mobile_font_size: Custom mobile font size from sticky ATC
  - dd_letter_spacing: Custom letter spacing from sticky ATC
  - dd_date_format: Date display format (e.g., weekday_month_day, month_day)
{% endcomment %}

{% assign shipping_days = shipping_days | default: 5 | plus: 0 %}
{% assign holidays = holidays | default: blank %}
{% assign text_before = text_before | default: 'Arrives by' %}
{% assign text_after = text_after | default: '' %}
{% assign show_icon = show_icon | default: true %}
{% assign accent_color = accent_color | default: '#00C7FF' %}
{% assign background_color = background_color | default: 'transparent' %}
{% assign output_format = output_format | default: 'normal' %}

{% comment %} --- Custom Styling Parameters from Sticky ATC --- {% endcomment %}
{% assign custom_text_color = dd_text_color | default: text_color | default: '#333333' %}
{% assign custom_font_weight = dd_font_weight | default: 'var(--font-weight-regular)' %}
{% assign custom_desktop_font_size = dd_desktop_font_size | default: 14 %}
{% assign custom_mobile_font_size = dd_mobile_font_size | default: 12 %}
{% assign custom_letter_spacing = dd_letter_spacing | default: 0 %}
{% assign custom_date_format_option = dd_date_format | default: 'weekday_month_day' %}

{% assign today = 'now' | date: '%s' %}
{% assign seconds_in_day = 86400 %}
{% assign shipping_days_in_seconds = shipping_days | times: seconds_in_day %}
{% assign delivery_date_seconds = today | plus: shipping_days_in_seconds %}

{% comment %} Set date format string based on option {% endcomment %}
{% if custom_date_format_option == 'month_day_weekday' %}
  {% assign date_format_string = '%b %-d, %A' %}
{% elsif custom_date_format_option == 'month_day' %}
  {% assign date_format_string = '%b %-d' %}
{% elsif custom_date_format_option == 'day_month' %}
  {% assign date_format_string = '%-d %b' %}
{% else %}
  {% assign date_format_string = '%A, %b %-d' %}
{% endif %}

{% assign formatted_delivery_date = delivery_date_seconds | date: date_format_string %}

{% if output_format == 'text_only' %}
  {{ formatted_delivery_date }}
{% else %}
  <span class="delivery-date-calculator" style="background-color: {{ background_color }};">
    {% if show_icon %}
      <svg width="20" height="20" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" class="delivery-date-calculator__icon">
        <path d="M311.069,130.515c-0.963-5.641-5.851-9.768-11.578-9.768H35.43c-7.61,0-13.772,6.169-13.772,13.765
          c0,7.61,6.162,13.772,13.772,13.772h64.263c7.61,0,13.772,6.17,13.772,13.773c0,7.603-6.162,13.772-13.772,13.772H13.772
          C6.169,175.829,0,181.998,0,189.601c0,7.603,6.169,13.764,13.772,13.764h117.114c6.72,0,12.172,5.46,12.172,12.18
          c0,6.72-5.452,12.172-12.172,12.172H68.665c-7.61,0-13.772,6.17-13.772,13.773c0,7.602,6.162,13.772,13.772,13.772h45.857
          c6.726,0,12.179,5.452,12.179,12.172c0,6.719-5.453,12.172-12.179,12.172H51.215c-7.61,0-13.772,6.169-13.772,13.772
          c0,7.603,6.162,13.772,13.772,13.772h87.014l5.488,31.042h31.52c-1.854,4.504-2.911,9.421-2.911,14.598
          c0,21.245,17.218,38.464,38.464,38.464c21.237,0,38.456-17.219,38.456-38.464c0-5.177-1.057-10.094-2.911-14.598h100.04
          L311.069,130.515z M227.342,352.789c0,9.146-7.407,16.553-16.553,16.553c-9.152,0-16.56-7.407-16.56-16.553
          c0-6.364,3.627-11.824,8.892-14.598h15.329C223.714,340.965,227.342,346.424,227.342,352.789z" fill="{{ accent_color }}"/>
        <path d="M511.598,314.072l-15.799-77.941l-57.689-88.759H333.074l32.534,190.819h38.42
          c-1.846,4.504-2.904,9.421-2.904,14.598c0,21.245,17.219,38.464,38.456,38.464c21.246,0,38.464-17.219,38.464-38.464
          c0-5.177-1.057-10.094-2.91-14.598h16.741c6.039,0,11.759-2.708,15.582-7.386C511.273,326.136,512.8,319.988,511.598,314.072z
          M392.529,182.882h26.314l34.162,52.547h-51.512L392.529,182.882z M456.14,352.789c0,9.146-7.407,16.553-16.56,16.553
          c-9.138,0-16.552-7.407-16.552-16.553c0-6.364,3.635-11.824,8.892-14.598h15.329C452.513,340.965,456.14,346.424,456.14,352.789z" fill="{{ accent_color }}"/>
      </svg>
    {% endif %}
    <span class="delivery-date-calculator__text" style="color: {{ custom_text_color }};">
      {{ text_before }} <span class="delivery-date-calculator__date" style="color: {{ accent_color }};">{{ formatted_delivery_date }}</span> {{ text_after }}
    </span>
  </span>

  <style>
    .delivery-date-calculator {
      display: inline-flex;
      align-items: center;
    }
    
    .delivery-date-calculator__icon {
      flex-shrink: 0;
      margin-right: 5px;
    }
    
    .delivery-date-calculator__text {
      display: inline;
      font-weight: {{ custom_font_weight }};
      font-size: {{ custom_mobile_font_size }}px;
      letter-spacing: {{ custom_letter_spacing }}px;
      color: {{ custom_text_color }}; /* Ensure color is applied here if not inline */
    }
    
    .delivery-date-calculator__date {
      font-weight: var(--font-weight-semibold); /* This could also be made customizable if needed */
      white-space: nowrap;
    }

    @media (min-width: 768px) { /* Assuming 768px is your desktop breakpoint */
      .delivery-date-calculator__text {
        font-size: {{ custom_desktop_font_size }}px;
      }
    }
  </style>
{% endif %}
